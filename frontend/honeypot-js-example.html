<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Honeypot with JavaScript</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-lg shadow-md p-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-6 text-center">Dynamic Form with Honeypot</h1>
        
        <form id="contactForm" class="space-y-4">
            <!-- Visible form fields -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                <input 
                    type="text" 
                    id="name" 
                    name="name" 
                    placeholder="Your Name" 
                    required 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500"
                >
            </div>
            
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    placeholder="your@email.com" 
                    required 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500"
                >
            </div>
            
            <div>
                <label for="message" class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                <textarea 
                    id="message" 
                    name="message" 
                    rows="4" 
                    placeholder="Your message..." 
                    required 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500"
                ></textarea>
            </div>
            
            <button 
                type="submit" 
                class="w-full bg-gray-900 text-white py-2 px-4 rounded-md hover:bg-gray-800 transition-colors"
            >
                Send Message
            </button>
        </form>
        
        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
            <h3 class="text-sm font-medium text-blue-900 mb-2">ðŸ”’ How CAPTCHA Security Works:</h3>
            <div class="text-sm text-blue-700 space-y-2">
                <div><strong>1. Dashboard Setup:</strong> Enable "CAPTCHA" toggle in form settings</div>
                <div><strong>2. Backend Config:</strong> Add RECAPTCHA_SECRET_KEY to environment variables</div>
                <div><strong>3. Frontend Widget:</strong> Add Google reCAPTCHA widget to your form</div>
                <div><strong>4. User Interaction:</strong> Visitor completes "I'm not a robot" challenge</div>
                <div><strong>5. Token Generation:</strong> Google generates unique token for this session</div>
                <div><strong>6. Form Submission:</strong> Token sent to backend with form data</div>
                <div><strong>7. Server Verification:</strong> Backend verifies token with Google's servers</div>
                <div><strong>8. Result:</strong> Valid token = form processed, Invalid token = rejected</div>
            </div>
        </div>
        
        <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
            <h3 class="text-sm font-medium text-green-900 mb-2">ðŸ”§ JavaScript Implementation:</h3>
            <pre class="text-xs text-green-700 bg-green-100 p-2 rounded overflow-x-auto"><code>// STEP 1: Load Google reCAPTCHA script
function loadRecaptcha() {
    const script = document.createElement('script');
    script.src = 'https://www.google.com/recaptcha/api.js';
    document.head.appendChild(script);
}

// STEP 2: Initialize reCAPTCHA widget
window.onRecaptchaLoad = function() {
    grecaptcha.render('recaptcha-container', {
        'sitekey': 'YOUR_SITE_KEY'
    });
}

// STEP 3: Get token on form submission
const recaptchaToken = grecaptcha.getResponse();
formData.append('g-recaptcha-response', recaptchaToken);

// STEP 4: Submit to backend
fetch('your-endpoint', { method: 'POST', body: formData });</code></pre>
        </div>
    </div>

    <script>
        // ========================================
        // CAPTCHA AND HONEYPOT IMPLEMENTATION
        // ========================================
        
        /**
         * STEP 1: Add honeypot field dynamically
         * This function creates a hidden field that bots will fill but humans won't see
         * The backend checks if this field is filled - if yes, it's spam
         */
        function addHoneypotField(form) {
            // Create a hidden input field
            const honeypot = document.createElement('input');
            honeypot.type = 'text';
            honeypot.name = 'honeypot'; // Backend looks for this specific field name
            
            // Hide the field completely from users
            honeypot.style.cssText = 'position: absolute; left: -9999px; opacity: 0; pointer-events: none;';
            
            // Additional accessibility attributes
            honeypot.setAttribute('tabindex', '-1');     // Skip in tab navigation
            honeypot.setAttribute('autocomplete', 'off'); // Disable autofill
            honeypot.setAttribute('aria-hidden', 'true'); // Hide from screen readers
            
            // Add the hidden field to the form
            form.appendChild(honeypot);
        }

        /**
         * STEP 2: Add reCAPTCHA token to form data
         * This function gets the reCAPTCHA token from Google's widget
         * The backend will verify this token with Google's servers
         */
        function addRecaptchaToken(formData) {
            // Get the reCAPTCHA response token
            // This token is generated by Google when user completes the "I'm not a robot" challenge
            const recaptchaToken = grecaptcha.getResponse();
            
            // Check if user completed the reCAPTCHA
            if (!recaptchaToken) {
                throw new Error('Please complete the reCAPTCHA verification');
            }
            
            // Add the token to form data with the field name the backend expects
            // Backend looks for either 'g-recaptcha-response' or 'recaptcha_token'
            formData.append('g-recaptcha-response', recaptchaToken);
            
            console.log('reCAPTCHA token added:', recaptchaToken.substring(0, 20) + '...');
        }

        /**
         * STEP 3: Handle form submission with CAPTCHA and honeypot
         * This is where all the security checks happen before sending to backend
         */
        document.getElementById('contactForm').addEventListener('submit', function(e) {
            // Prevent default form submission (we'll handle it with JavaScript)
            e.preventDefault();
            
            console.log('Form submission started...');
            
            try {
                // Add honeypot field to catch bots
                console.log('Adding honeypot field...');
                addHoneypotField(this);
                
                // Create FormData object with all form fields
                console.log('Creating form data...');
                const formData = new FormData(this);
                
                // Add reCAPTCHA token to form data
                console.log('Adding reCAPTCHA token...');
                addRecaptchaToken(formData);
                
                // Log what we're sending (for debugging)
                console.log('Form data contents:');
                for (let [key, value] of formData.entries()) {
                    if (key === 'g-recaptcha-response') {
                        console.log(`${key}: ${value.substring(0, 20)}...`);
                    } else {
                        console.log(`${key}: ${value}`);
                    }
                }
                
                // Submit form to backend
                console.log('Submitting to backend...');
                fetch('http://localhost:4001/api/f/your-endpoint-slug', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log('Backend response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Backend response:', data);
                    
                    if (data.success) {
                        alert('Message sent successfully!');
                        this.reset(); // Clear the form
                        
                        // Reset reCAPTCHA widget for next submission
                        if (typeof grecaptcha !== 'undefined') {
                            grecaptcha.reset();
                        }
                    } else {
                        alert('Failed to send message: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Submission error:', error);
                    alert('Failed to send message. Please try again.');
                });
                
            } catch (error) {
                // Handle any errors (like missing reCAPTCHA)
                console.error('Form processing error:', error);
                alert(error.message);
            }
        });

        /**
         * STEP 4: Load Google reCAPTCHA script dynamically
         * This function loads the reCAPTCHA library from Google
         */
        function loadRecaptcha() {
            console.log('Loading Google reCAPTCHA script...');
            
            // Create script element to load reCAPTCHA
            const script = document.createElement('script');
            script.src = 'https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit';
            script.async = true;
            script.defer = true;
            
            // Add to page head
            document.head.appendChild(script);
        }

        /**
         * STEP 5: Initialize reCAPTCHA widget when script loads
         * This function is called by Google's reCAPTCHA script when it's ready
         */
        window.onRecaptchaLoad = function() {
            console.log('Google reCAPTCHA script loaded, initializing widget...');
            
            // Render the reCAPTCHA widget in the container
            grecaptcha.render('recaptcha-container', {
                'sitekey': RECAPTCHA_SITE_KEY, // Your public site key from Google
                'theme': 'light',              // 'light' or 'dark'
                'size': 'normal',              // 'compact' or 'normal'
                'callback': function(token) {
                    // Called when user completes reCAPTCHA
                    console.log('reCAPTCHA completed, token:', token.substring(0, 20) + '...');
                },
                'expired-callback': function() {
                    // Called when reCAPTCHA expires (after 2 minutes)
                    console.log('reCAPTCHA expired, user needs to complete again');
                    alert('reCAPTCHA expired. Please complete it again.');
                },
                'error-callback': function() {
                    // Called when there's an error with reCAPTCHA
                    console.error('reCAPTCHA error occurred');
                    alert('reCAPTCHA error. Please refresh the page.');
                }
            });
            
            console.log('reCAPTCHA widget initialized successfully');
        };

        // Load reCAPTCHA when page loads
        loadRecaptcha();
    </script>
</body>
</html>
